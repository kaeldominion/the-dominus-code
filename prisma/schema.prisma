// Prisma Schema for The Dominus Code
// Database: PostgreSQL (recommended) or SQLite for development

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ═══════════════════════════════════════════════════════════════
// USER & AUTHENTICATION
// ═══════════════════════════════════════════════════════════════

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  handle        String?   @unique // For the Oath Wall
  passwordHash  String?
  image         String?
  emailVerified DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  accounts      Account[]
  sessions      Session[]
  purchases     Purchase[]
  oathSignature OathSignature?
  assessments   Assessment[]
  councilMember CouncilMember?

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ═══════════════════════════════════════════════════════════════
// PRODUCTS & PURCHASES
// ═══════════════════════════════════════════════════════════════

model Product {
  id          String   @id @default(cuid())
  slug        String   @unique
  name        String
  description String?
  price       Int      // In cents
  type        ProductType
  active      Boolean  @default(true)
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  purchases Purchase[]

  @@map("products")
}

enum ProductType {
  BOOK_PHYSICAL
  BOOK_DIGITAL
  BUNDLE
  DIGITAL_PRODUCT
  SUBSCRIPTION
}

model Purchase {
  id              String        @id @default(cuid())
  userId          String
  productId       String
  status          PurchaseStatus @default(PENDING)
  amount          Int           // In cents
  stripePaymentId String?
  bookCode        String?       @unique // Unique code for oath wall access
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@map("purchases")
}

enum PurchaseStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

// ═══════════════════════════════════════════════════════════════
// THE OATH WALL
// ═══════════════════════════════════════════════════════════════

model OathSignature {
  id        String   @id @default(cuid())
  userId    String   @unique
  handle    String   @unique
  bookCode  String   @unique
  signedAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("oath_signatures")
}

// ═══════════════════════════════════════════════════════════════
// SOVEREIGNTY ASSESSMENT
// ═══════════════════════════════════════════════════════════════

model Assessment {
  id        String   @id @default(cuid())
  userId    String?
  email     String?
  score     Int
  answers   Json     // Store all answers as JSON
  category  String   // SOVEREIGN, AWAKENING, DORMANT, ASLEEP
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("assessments")
}

// ═══════════════════════════════════════════════════════════════
// THE COUNCIL (MEMBERSHIP)
// ═══════════════════════════════════════════════════════════════

model CouncilMember {
  id               String             @id @default(cuid())
  userId           String             @unique
  status           MembershipStatus   @default(PENDING)
  tier             MembershipTier     @default(MONTHLY)
  stripeCustomerId String?
  stripeSubId      String?
  startDate        DateTime?
  endDate          DateTime?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("council_members")
}

enum MembershipStatus {
  PENDING
  ACTIVE
  PAUSED
  CANCELLED
  EXPIRED
}

enum MembershipTier {
  MONTHLY
  ANNUAL
}

// ═══════════════════════════════════════════════════════════════
// EMAIL SUBSCRIBERS
// ═══════════════════════════════════════════════════════════════

model Subscriber {
  id           String   @id @default(cuid())
  email        String   @unique
  source       String?  // Where they signed up (assessment, footer, etc.)
  tags         Json?    // For segmentation (stored as JSON array)
  unsubscribed Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("subscribers")
}

// ═══════════════════════════════════════════════════════════════
// LIVE STATUS (For the Protocol Dashboard)
// ═══════════════════════════════════════════════════════════════

model LiveStatus {
  id        String   @id @default(cuid())
  status    String   // DEEP_WORK, TRAINING, FAMILY, BUILDING, REST
  message   String?
  startedAt DateTime @default(now())
  endedAt   DateTime?

  @@map("live_status")
}

// ═══════════════════════════════════════════════════════════════
// APPLICATIONS (Council & Dynasty)
// ═══════════════════════════════════════════════════════════════

model Application {
  id              String            @id @default(cuid())
  type            ApplicationType
  name            String?
  email           String?
  formData        Json              // Store all answers as JSON
  aiVerdict       String?           // APPROVED, REJECT, RECEIVED, etc.
  aiAnalysis      String?           // AI's analysis text
  status          ApplicationStatus @default(PENDING)
  submittedAt     DateTime          @default(now())
  reviewedAt      DateTime?
  notes           String?           // Admin notes

  @@map("applications")
}

enum ApplicationType {
  COUNCIL
  DYNASTY
}

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
  WAITLIST
}

